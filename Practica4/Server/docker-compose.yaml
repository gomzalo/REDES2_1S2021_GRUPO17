version: "2.4"
services:

  db:
    # build: ../Database/mysql
    build: ./db/mysql
    # image: mysql
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    # environment: 
    #   - MYSQL_ROOT_PASSWORD=123  
    env_file: 
      - .env
    ports:
      - "3306"
    networks:
      - red-db
  #se crea un servicio con un contenedor el cual utiliza la imagen api-servidor1
  #esta api despliega un mensaje simple, al visitar el endpoint
  # http://localhost:5000/mensaje
  server1:
    image: gomzalo/r2-server-p4:latest
    # build: ./
    ports:
     - "5002:6001"
    #se conecta el contenedor a la red "red-servidores"
    depends_on:
     - db
    environment:
    - USER_NAME=users_service
    - PORT=3306
    - HOST=db
    - DB_NAME=test
    - PASS=123
    networks:
      - red-servidores
      - red-db
  #se crea un segundo servicio con un contenedor el cual utiliza la imagen api-servidor2
  #esta api despliega un mensaje simple, al visitar el endpoint
  # http://localhost:5001/mensaje
  server2:
    image: gomzalo/r2-server-p4:latest
    # build: ./
    ports:
     - "5001:6000"
    #se conecta el contenedor a la red "red-servidores"
    depends_on:
     - db
    environment:
    - USER_NAME=users_service
    - PORT=3306
    - HOST=db
    - DB_NAME=test
    - PASS=123
    networks:
      - red-servidores
      - red-db
  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - server1
      #- server2
    ports:
      - "4000:4000"
    networks:
      - red-servidores
#aqui se crean las networks
networks:
  #se crea la red "red-servidores" usando el driver de tipo "bridge"
  red-servidores:
    driver: bridge

  red-db:
      driver: bridge
